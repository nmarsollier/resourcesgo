
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>languages: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/nmarsollier/resourcesgo/internal/languages/create.go (100.0%)</option>
				
				<option value="file1">github.com/nmarsollier/resourcesgo/internal/languages/find_by_id.go (100.0%)</option>
				
				<option value="file2">github.com/nmarsollier/resourcesgo/internal/languages/schema.go (100.0%)</option>
				
				<option value="file3">github.com/nmarsollier/resourcesgo/internal/projects/create.go (100.0%)</option>
				
				<option value="file4">github.com/nmarsollier/resourcesgo/internal/projects/find_by_id.go (100.0%)</option>
				
				<option value="file5">github.com/nmarsollier/resourcesgo/internal/projects/schema.go (100.0%)</option>
				
				<option value="file6">github.com/nmarsollier/resourcesgo/internal/resources/create.go (100.0%)</option>
				
				<option value="file7">github.com/nmarsollier/resourcesgo/internal/resources/delete.go (100.0%)</option>
				
				<option value="file8">github.com/nmarsollier/resourcesgo/internal/resources/find_by.go (100.0%)</option>
				
				<option value="file9">github.com/nmarsollier/resourcesgo/internal/resources/find_by_id.go (100.0%)</option>
				
				<option value="file10">github.com/nmarsollier/resourcesgo/internal/resources/find_versions.go (100.0%)</option>
				
				<option value="file11">github.com/nmarsollier/resourcesgo/internal/resources/get_last_resource.go (52.1%)</option>
				
				<option value="file12">github.com/nmarsollier/resourcesgo/internal/resources/schema.go (50.0%)</option>
				
				<option value="file13">github.com/nmarsollier/resourcesgo/internal/rest/delete_resource.go (0.0%)</option>
				
				<option value="file14">github.com/nmarsollier/resourcesgo/internal/rest/get_language.go (0.0%)</option>
				
				<option value="file15">github.com/nmarsollier/resourcesgo/internal/rest/get_project.go (0.0%)</option>
				
				<option value="file16">github.com/nmarsollier/resourcesgo/internal/rest/get_resource.go (0.0%)</option>
				
				<option value="file17">github.com/nmarsollier/resourcesgo/internal/rest/get_versions.go (0.0%)</option>
				
				<option value="file18">github.com/nmarsollier/resourcesgo/internal/rest/post_language.go (0.0%)</option>
				
				<option value="file19">github.com/nmarsollier/resourcesgo/internal/rest/post_project.go (0.0%)</option>
				
				<option value="file20">github.com/nmarsollier/resourcesgo/internal/rest/post_resources.go (0.0%)</option>
				
				<option value="file21">github.com/nmarsollier/resourcesgo/internal/rest/router.go (0.0%)</option>
				
				<option value="file22">github.com/nmarsollier/resourcesgo/internal/rest/server/engine.go (0.0%)</option>
				
				<option value="file23">github.com/nmarsollier/resourcesgo/internal/rest/server/error_handler.go (0.0%)</option>
				
				<option value="file24">github.com/nmarsollier/resourcesgo/internal/rest/server/logger_middleware.go (0.0%)</option>
				
				<option value="file25">github.com/nmarsollier/resourcesgo/internal/tools/env/env.go (100.0%)</option>
				
				<option value="file26">github.com/nmarsollier/resourcesgo/internal/tools/errs/custom.go (100.0%)</option>
				
				<option value="file27">github.com/nmarsollier/resourcesgo/internal/tools/errs/validation.go (100.0%)</option>
				
				<option value="file28">github.com/nmarsollier/resourcesgo/internal/tools/logx/context.go (87.5%)</option>
				
				<option value="file29">github.com/nmarsollier/resourcesgo/internal/tools/logx/fields.go (100.0%)</option>
				
				<option value="file30">github.com/nmarsollier/resourcesgo/internal/tools/logx/logger.go (100.0%)</option>
				
				<option value="file31">github.com/nmarsollier/resourcesgo/internal/tools/strs/json.go (100.0%)</option>
				
				<option value="file32">github.com/nmarsollier/resourcesgo/internal/tools/strs/numbers.go (100.0%)</option>
				
				<option value="file33">github.com/nmarsollier/resourcesgo/main.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package languages

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
        "github.com/nmarsollier/resourcesgo/internal/tools/errs"
)

var dbExec = db.Exec

func Create(ctx context.Context, id string, name string) (string, error) <span class="cov8" title="1">{
        language := newLanguage(id, name)

        if err := language.ValidateSchema(); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        <span class="cov8" title="1">err := dbExec(
                ctx,
                "INSERT INTO languages (id, name, created, enabled) VALUES ($1, $2, $3, $4)",
                language.ID,
                language.Name,
                language.Created,
                language.Enabled,
        )

        if err != nil </span><span class="cov8" title="1">{
                switch db.ErrorCode(err) </span>{
                case db.ERR_EXIST:<span class="cov8" title="1">
                        return "", errs.AlreadyExist</span>
                }

                <span class="cov8" title="1">return "", err</span>
        }

        <span class="cov8" title="1">return language.ID, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package languages

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
)

var dbQueryRow = db.QueryRow[Language]

func FindByID(ctx context.Context, id string) (*Language, error) <span class="cov8" title="1">{
        return dbQueryRow(
                ctx,
                `
      SELECT id, name, created, enabled
      FROM languages
      WHERE id = $1
    `,
                id,
        )
}</span>
</pre>
		
		<pre class="file" id="file2" style="display: none">package languages

import (
        "time"

        "github.com/go-playground/validator/v10"
)

type Language struct {
        ID      string    `db:"id" json:"id"  validate:"required,min=2,max=6"`
        Name    string    `db:"name" json:"name" validate:"required,min=1,max=20"`
        Created time.Time `db:"created" json:"created"`
        Enabled bool      `db:"enabled" json:"enabled"`
}

func newLanguage(id string, name string) *Language <span class="cov8" title="1">{
        return &amp;Language{
                ID:      id,
                Enabled: true,
                Created: time.Now(),
                Name:    name,
        }
}</span>

func (e *Language) ValidateSchema() error <span class="cov8" title="1">{
        return validator.New().Struct(e)
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">package projects

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
        "github.com/nmarsollier/resourcesgo/internal/tools/errs"
)

var dbExec = db.Exec

func Create(ctx context.Context, id string, name string) (string, error) <span class="cov8" title="1">{
        project := newProject(id, name)

        if err := project.ValidateSchema(); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        <span class="cov8" title="1">err := dbExec(
                ctx,
                "INSERT INTO projects (id, name, created, enabled) VALUES ($1, $2, $3, $4)",
                project.ID, project.Name, project.Created, project.Enabled)

        if err != nil </span><span class="cov8" title="1">{
                switch db.ErrorCode(err) </span>{
                case db.ERR_EXIST:<span class="cov8" title="1">
                        return "", errs.AlreadyExist</span>
                }

                <span class="cov8" title="1">return "", err</span>
        }

        <span class="cov8" title="1">return project.ID, nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package projects

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
)

var dbQueryRow = db.QueryRow[Project]

func FindByID(ctx context.Context, id string) (*Project, error) <span class="cov8" title="1">{
        return dbQueryRow(
                ctx,
                `
      SELECT id, name, created, enabled
      FROM projects
      WHERE id = $1
    `,
                id,
        )
}</span>
</pre>
		
		<pre class="file" id="file5" style="display: none">package projects

import (
        "time"

        "github.com/go-playground/validator/v10"
)

type Project struct {
        ID      string    `db:"id" json:"id" validate:"required,min=2,max=20"`
        Name    string    `db:"name" json:"name" validate:"required,min=1,max=20"`
        Created time.Time `db:"created" json:"created"`
        Enabled bool      `db:"enabled" json:"enabled"`
}

func newProject(id string, name string) *Project <span class="cov8" title="1">{
        return &amp;Project{
                ID:      id,
                Enabled: true,
                Created: time.Now(),
                Name:    name,
        }
}</span>

func (e *Project) ValidateSchema() error <span class="cov8" title="1">{
        return validator.New().Struct(e)
}</span>
</pre>
		
		<pre class="file" id="file6" style="display: none">package resources

import (
        "context"
        "strings"

        "github.com/go-playground/validator/v10"
        "github.com/nmarsollier/resourcesgo/internal/tools/db"
        "github.com/nmarsollier/resourcesgo/internal/tools/errs"
)

var dbExec = db.Exec

func Create(
        ctx context.Context,
        resource *Resource,
) (string, error) <span class="cov8" title="1">{
        if err := validator.New().Struct(resource); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        <span class="cov8" title="1">resource, err := insert(ctx, resource)

        if err != nil </span><span class="cov8" title="1">{
                switch db.ErrorCode(err) </span>{
                case db.ERR_FOREIGN_KEY:<span class="cov8" title="1">
                        if strings.Contains(err.Error(), "language") </span><span class="cov8" title="1">{
                                return "", errs.ErrLanguageNotExist
                        }</span> else<span class="cov8" title="1"> {
                                return "", errs.ErrProjectNotExist
                        }</span>
                case db.ERR_EXIST:<span class="cov8" title="1">
                        return "", errs.AlreadyExist</span>
                }
                <span class="cov8" title="1">return "", err</span>
        }

        <span class="cov8" title="1">return resource.ID, nil</span>
}

func insert(
        ctx context.Context,
        resource *Resource,
) (*Resource, error) <span class="cov8" title="1">{
        err := dbExec(ctx,
                `
                INSERT INTO resources (id, project, language, sem_ver, values, created, enabled)
                VALUES ($1, $2, $3, $4, $5, $6, $7);
                `,
                resource.ID, resource.ProjectID, resource.LanguageID, resource.SemVer, resource.Values, resource.Created, resource.Enabled)

        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return resource, nil</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package resources

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
)

var dbDeleteExec = db.Exec

func Delete(ctx context.Context, project string, language string, semver string) error <span class="cov8" title="1">{
        resource, err := findBy(ctx, project, language, semver)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">return dbDeleteExec(
                ctx,
                "UPDATE resources SET enabled=false WHERE id=$1",
                resource.ID,
        )</span>
}
</pre>
		
		<pre class="file" id="file8" style="display: none">package resources

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
)

var dbQueryFindBy = db.QueryRow[Resource]

func findBy(ctx context.Context, project string, language string, semVer string) (*Resource, error) <span class="cov8" title="1">{
        return dbQueryFindBy(
                ctx,
                `
                SELECT id, project, language, sem_ver, values, created, enabled 
                FROM resources 
                WHERE project = $1 AND language = $2 AND sem_ver = $3
                `,
                project, language, semVer,
        )
}</span>
</pre>
		
		<pre class="file" id="file9" style="display: none">package resources

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
)

var dbQueryFindByID = db.QueryRow[Resource]

func FindByID(ctx context.Context, id string) (*Resource, error) <span class="cov8" title="1">{
        return dbQueryFindByID(
                ctx,
                `
                SELECT id, project, language, sem_ver, values, created, enabled 
                FROM resources 
                WHERE id = $1
                `,
                id,
        )
}</span>
</pre>
		
		<pre class="file" id="file10" style="display: none">package resources

import (
        "context"

        "github.com/nmarsollier/resourcesgo/internal/tools/db"
)

var dbQueryFindVersions = db.Query[string]

func FindVersions(ctx context.Context, project string, language string) ([]string, error) <span class="cov8" title="1">{
        data, err := dbQueryFindVersions(
                ctx,
                "SELECT sem_ver FROM resources WHERE project = $1 AND language = $2 AND enabled = true",
                project, language,
        )

        if err != nil </span><span class="cov8" title="1">{
                return make([]string, 0), err
        }</span>

        <span class="cov8" title="1">versions := make([]string, len(data))
        for i, v := range data </span><span class="cov8" title="1">{
                versions[i] = *v
        }</span>

        <span class="cov8" title="1">return versions, nil</span>
}
</pre>
		
		<pre class="file" id="file11" style="display: none">package resources

import (
        "context"
        "sort"
        "strconv"
        "strings"

        "github.com/nmarsollier/resourcesgo/internal/tools/errs"
)

func GetLastResource(ctx context.Context, project string, language string, semver string) (*Resource, error) <span class="cov0" title="0">{
        version, err := getLastVersion(ctx, project, language, semver)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return findBy(ctx, project, language, version)</span>
}

func getLastVersion(ctx context.Context, project string, language string, semver string) (string, error) <span class="cov0" title="0">{
        versions, err := FindVersions(ctx, project, language)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">var valids []string
        for i := 0; i &lt; len(versions); i++ </span><span class="cov0" title="0">{
                if isValidSemver(versions[i], semver) </span><span class="cov0" title="0">{
                        valids = append(valids, versions[i])
                }</span>
        }

        <span class="cov0" title="0">sort.Sort(sort.Reverse(sort.StringSlice(valids)))

        if len(valids) &gt; 0 </span><span class="cov0" title="0">{
                return valids[0], nil
        }</span>

        <span class="cov0" title="0">return "", errs.NotFound</span>
}

func isValidSemver(version string, semVer string) bool <span class="cov8" title="1">{
        if strings.HasSuffix(semVer, "+") || strings.HasSuffix(semVer, "*") </span><span class="cov8" title="1">{
                newSemVer := strings.ReplaceAll(semVer, "+", "")
                newSemVer = strings.ReplaceAll(newSemVer, "*", "")
                return strings.HasPrefix(version, newSemVer)
        }</span>

        <span class="cov8" title="1">versionArray := strings.Split(version, ".")
        semVerArray := strings.Split(semVer, ".")

        if len(versionArray) != 3 || len(semVerArray) != 3 </span><span class="cov8" title="1">{
                return false
        }</span>

        <span class="cov8" title="1">v1, err := strconv.Atoi(versionArray[0])
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">s1, err := strconv.Atoi(semVerArray[0])
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">if v1 &gt; s1 </span><span class="cov0" title="0">{
                return false
        }</span>

        <span class="cov8" title="1">v2, err := strconv.Atoi(versionArray[1])
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">s2, err := strconv.Atoi(semVerArray[1])
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">if v2 &gt; s2 </span><span class="cov8" title="1">{
                return false
        }</span>

        <span class="cov8" title="1">v3, err := strconv.Atoi(versionArray[2])
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">s3, err := strconv.Atoi(semVerArray[2])
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">if v3 &gt; s3 </span><span class="cov0" title="0">{
                return false
        }</span>

        <span class="cov8" title="1">return true</span>
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package resources

import (
        "time"

        "github.com/go-playground/validator/v10"
        "github.com/google/uuid"
)

type Resource struct {
        ID         string            `db:"id"`
        ProjectID  string            `db:"project" validate:"required,min=1,max=20"`
        LanguageID string            `db:"language" validate:"required,min=1,max=20"`
        SemVer     string            `db:"sem_ver" validate:"required,min=5,max=50"`
        Values     map[string]string `db:"values"`
        Created    time.Time         `db:"created"`
        Enabled    bool              `db:"enabled"`
}

func NewResource(
        projectID string,
        languageID string,
        semVer string,
        values map[string]string,
) *Resource <span class="cov8" title="1">{
        return &amp;Resource{
                ID:         uuid.New().String(),
                ProjectID:  projectID,
                LanguageID: languageID,
                SemVer:     semVer,
                Values:     values,
                Enabled:    true,
                Created:    time.Now(),
        }
}</span>

func (e *Resource) ValidateSchema() error <span class="cov0" title="0">{
        return validator.New().Struct(e)
}</span>
</pre>
		
		<pre class="file" id="file13" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/resources"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Marks a resource as deleted.
//        @Description        Delete a resource. The id is not deleted, cannot be reused.
//        @Tags                        Resources
//        @Accept                        json
//        @Produce                json
//        @Param                        projectId        path        string        true        "Project ID"
//        @Param                        languageId        path        string        true        "language tag"
//        @Param                        semver                path        string        true        "Sem version, you can not use wildcards"
//        @Success                200                        "No Content"
//        @Failure                400                        {object}        errs.Validation        "Bad Request"
//        @Failure                404                        {object}        errs.Custom                "Not Found"
//        @Failure                500                        {object}        errs.Custom                "Internal Server Error"
//        @Router                        /resources/{projectId}/{languageId}/{semver} [delete]
//
// Marks a resource as deleted.
func initDeleteResource(engine *gin.Engine) <span class="cov0" title="0">{
        engine.DELETE(
                "/resources/:projectId/:languageId/:semver",
                deleteResource,
        )
}</span>

func deleteResource(c *gin.Context) <span class="cov0" title="0">{
        resources.Delete(
                server.GinLogCtx(c),
                c.Param("projectId"),
                c.Param("languageId"),
                c.Param("semver"),
        )
}</span>
</pre>
		
		<pre class="file" id="file14" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/languages"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Gets a language detail
//        @Description        Gets language details.
//        @Tags                        Languages
//        @Accept                        json
//        @Produce                json
//        @Param                        languageId        path                string                        true        "Language ID"
//        @Success                200                        {object}        Language                "Project"
//        @Failure                400                        {object}        errs.Validation        "Bad Request"
//        @Failure                404                        {object}        errs.Custom                "Not Found"
//        @Failure                500                        {object}        errs.Custom                "Internal Server Error"
//        @Router                        /languages/:languageId [get]
//
// Gets a project details.
func initGetLanguage(engine *gin.Engine) <span class="cov0" title="0">{
        engine.GET("/languages/:languageId", getLanguage)
}</span>

func getLanguage(c *gin.Context) <span class="cov0" title="0">{
        proj, err := languages.FindByID(server.GinLogCtx(c), c.Param("languageId"))

        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, &amp;Language{
                ID:   proj.ID,
                Name: proj.Name,
        })</span>
}

type Language struct {
        ID   string `json:"id"`
        Name string `json:"name"`
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/projects"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Gets a project detail
//        @Description        Gets projects details.
//        @Tags                        Project
//        @Accept                        json
//        @Produce                json
//        @Param                        projectId        path                string                        true        "Project ID"
//        @Success                200                        {object}        Project                        "Project"
//        @Failure                400                        {object}        errs.Validation        "Bad Request"
//        @Failure                404                        {object}        errs.Custom                "Not Found"
//        @Failure                500                        {object}        errs.Custom                "Internal Server Error"
//        @Router                        /projects/{projectId} [get]
//
// Gets a project details.
func initGetProject(engine *gin.Engine) <span class="cov0" title="0">{
        engine.GET("/projects/:projectId", getProject)
}</span>

func getProject(c *gin.Context) <span class="cov0" title="0">{
        proj, err := projects.FindByID(server.GinLogCtx(c), c.Param("projectId"))

        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, &amp;Project{
                ID:   proj.ID,
                Name: proj.Name,
        })</span>
}

type Project struct {
        ID   string `json:"id"`
        Name string `json:"name"`
}
</pre>
		
		<pre class="file" id="file16" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/resources"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Gets a resource
//        @Description        Gets the latest resource given a semver.
//        @Tags                        Resources
//        @Accept                        json
//        @Produce                json
//        @Param                        projectId        path                string                        true        "Project ID"
//        @Param                        languageId        path                string                        true        "language tag"
//        @Param                        semver                path                string                        true        "Sem version, you can use wildcards + or *"
//        @Success                200                        {object}        Resource                "Resource"
//        @Failure                400                        {object}        errs.Validation        "Bad Request"
//        @Failure                404                        {object}        errs.Custom                "Not Found"
//        @Failure                500                        {object}        errs.Custom                "Internal Server Error"
//        @Router                        /resources/{projectId}/{languageId}/{semver} [get]
//
// Gets the last resource.
func initGetResources(engine *gin.Engine) <span class="cov0" title="0">{
        engine.GET("/resources/:projectId/:languageId/:semver", getResource)
}</span>

func getResource(c *gin.Context) <span class="cov0" title="0">{
        res, err := resources.GetLastResource(
                server.GinLogCtx(c),
                c.Param("projectId"),
                c.Param("languageId"),
                c.Param("semver"),
        )

        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, &amp;Resource{
                ID:         res.ID,
                ProjectID:  res.ProjectID,
                LanguageID: res.LanguageID,
                SemVer:     res.SemVer,
                Values:     res.Values,
        })</span>
}

type Resource struct {
        ID         string            `json:"id"`
        ProjectID  string            `json:"projectId"`
        LanguageID string            `json:"languageId"`
        SemVer     string            `json:"semver"`
        Values     map[string]string `json:"values"`
}
</pre>
		
		<pre class="file" id="file17" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/resources"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Gets versions
//        @Description        Gets available versions for a resource.
//        @Tags                        Resources
//        @Accept                        json
//        @Produce                json
//        @Param                        projectId        path                string                        true        "Project ID"
//        @Param                        languageId        path                string                        true        "language tag"
//        @Success                200                        {Array}                string                        "Versions"
//        @Failure                400                        {object}        errs.Validation        "Bad Request"
//        @Failure                404                        {object}        errs.Custom                "Not Found"
//        @Failure                500                        {object}        errs.Custom                "Internal Server Error"
//        @Router                        /versions/{projectId}/{languageId} [get]
//
// Gets the last resource.
func initGetVersions(engine *gin.Engine) <span class="cov0" title="0">{
        engine.GET("/versions/:projectId/:languageId", getVersions)
}</span>

func getVersions(c *gin.Context) <span class="cov0" title="0">{
        versions, err := resources.FindVersions(
                server.GinLogCtx(c),
                c.Param("projectId"),
                c.Param("languageId"),
        )

        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, versions)</span>
}
</pre>
		
		<pre class="file" id="file18" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/languages"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Create a language
//        @Description        Create a new language tag.
//        @Tags                        Languages
//        @Accept                        json
//        @Produce                json
//        @Param                        body        body                CreateLanguageBody        true        "Language to add"
//        @Success                200                {object}        IDResult                        "Language ID"
//        @Failure                400                {object}        errs.Validation                "Bad Request"
//        @Failure                404                {object}        errs.Custom                        "Not Found"
//        @Failure                500                {object}        errs.Custom                        "Internal Server Error"
//        @Router                        /languages [post]
//
// Create a new project tab
func initPostLanguage(engine *gin.Engine) <span class="cov0" title="0">{
        engine.POST("/languages", saveLanguage)
}</span>

func saveLanguage(c *gin.Context) <span class="cov0" title="0">{
        body := CreateLanguageBody{}

        if err := c.ShouldBindJSON(&amp;body); err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">id, err := languages.Create(server.GinLogCtx(c), body.ID, body.Name)
        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, &amp;IDResult{id})</span>
}

type CreateLanguageBody struct {
        ID   string `json:"id" binding:"required"`
        Name string `json:"name" binding:"required"`
}
</pre>
		
		<pre class="file" id="file19" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/projects"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Create a project
//        @Description        Create a new project tag.
//        @Tags                        Project
//        @Accept                        json
//        @Produce                json
//        @Param                        body        body                CreateProjectBody        true        "Project to add"
//        @Success                200                {object}        IDResult                        "Project ID"
//        @Failure                400                {object}        errs.Validation                "Bad Request"
//        @Failure                404                {object}        errs.Custom                        "Not Found"
//        @Failure                500                {object}        errs.Custom                        "Internal Server Error"
//        @Router                        /projects [post]
//
// Create a new project tab
func initPostProjects(engine *gin.Engine) <span class="cov0" title="0">{
        engine.POST("/projects", saveProject)
}</span>

func saveProject(c *gin.Context) <span class="cov0" title="0">{
        body := CreateProjectBody{}

        if err := c.ShouldBindJSON(&amp;body); err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">id, err := projects.Create(server.GinLogCtx(c), body.ID, body.Name)
        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, &amp;IDResult{id})</span>
}

type CreateProjectBody struct {
        ID   string `json:"id" binding:"required"`
        Name string `json:"name" binding:"required"`
}
</pre>
		
		<pre class="file" id="file20" style="display: none">package rest

import (
        "github.com/gin-gonic/gin"
        "github.com/nmarsollier/resourcesgo/internal/resources"
        "github.com/nmarsollier/resourcesgo/internal/rest/server"
)

//        @Summary                Create a resource
//        @Description        Create a new resource.
//        @Tags                        Resources
//        @Accept                        json
//        @Produce                json
//        @Param                        body        body                CreateResourceBody        true        "Project to add"
//        @Success                200                {object}        IDResult                        "Project ID"
//        @Failure                400                {object}        errs.Validation                "Bad Request"
//        @Failure                404                {object}        errs.Custom                        "Not Found"
//        @Failure                500                {object}        errs.Custom                        "Internal Server Error"
//        @Router                        /resources [post]
//
// Create a new resource version
func initPostResources(engine *gin.Engine) <span class="cov0" title="0">{
        engine.POST("/resources", saveResource)
}</span>

func saveResource(c *gin.Context) <span class="cov0" title="0">{
        body := CreateResourceBody{}
        if err := c.ShouldBindJSON(&amp;body); err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">newRes := resources.NewResource(
                body.ProjectID,
                body.LanguageID,
                body.SemVer,
                body.Values,
        )

        id, err := resources.Create(server.GinLogCtx(c), newRes)
        if err != nil </span><span class="cov0" title="0">{
                server.AbortWithError(c, err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(200, &amp;IDResult{id})</span>
}

type CreateResourceBody struct {
        ProjectID  string            `json:"projectId" binding:"required"`
        LanguageID string            `json:"languageId" binding:"required"`
        SemVer     string            `json:"semver" binding:"required"`
        Values     map[string]string `json:"values" binding:"required"`
}
</pre>
		
		<pre class="file" id="file21" style="display: none">package rest

import (
        "fmt"

        "github.com/nmarsollier/resourcesgo/internal/rest/server"
        "github.com/nmarsollier/resourcesgo/internal/tools/env"
)

// Start this server
func Start() <span class="cov0" title="0">{
        engine := server.Router()
        initGetProject(engine)
        initGetLanguage(engine)
        initGetResources(engine)
        initGetVersions(engine)
        initPostResources(engine)
        initDeleteResource(engine)
        initPostProjects(engine)
        initPostLanguage(engine)
        engine.Run(fmt.Sprintf(":%d", env.Get().Port))
}</span>
</pre>
		
		<pre class="file" id="file22" style="display: none">package server

import (
        "time"

        "github.com/gin-contrib/gzip"
        "github.com/gin-gonic/gin"
        cors "github.com/itsjamie/gin-cors"
        _ "github.com/nmarsollier/resourcesgo/docs"
        swaggerFiles "github.com/swaggo/files"
        ginSwagger "github.com/swaggo/gin-swagger"
)

var engine *gin.Engine = nil

func Router() *gin.Engine <span class="cov0" title="0">{
        if engine != nil </span><span class="cov0" title="0">{
                return engine
        }</span>

        <span class="cov0" title="0">engine = gin.Default()

        engine.Use(gzip.Gzip(gzip.DefaultCompression))
        engine.Use(cors.Middleware(cors.Config{
                Origins:         "*",
                Methods:         "GET, PUT, POST, DELETE",
                RequestHeaders:  "Origin, Authorization, Content-Type",
                ExposedHeaders:  "",
                MaxAge:          50 * time.Second,
                Credentials:     false,
                ValidateHeaders: false,
        }))
        engine.Use(GinLoggerMiddleware())
        engine.Use(ErrorHandler)

        engine.GET("/docs/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))

        return engine</span>
}
</pre>
		
		<pre class="file" id="file23" style="display: none">package server

import (
        "strings"

        "github.com/gin-gonic/gin"
        "github.com/go-playground/validator"
        "github.com/nmarsollier/resourcesgo/internal/tools/errs"
)

func AbortWithError(c *gin.Context, err error) <span class="cov0" title="0">{
        c.Error(err)
        c.Abort()
}</span>

func ErrorHandler(c *gin.Context) <span class="cov0" title="0">{
        c.Next()

        err := c.Errors.Last()
        if err == nil </span><span class="cov0" title="0">{
                return
        }</span>

        <span class="cov0" title="0">switch value := err.Err.(type) </span>{
        case *errs.Custom:<span class="cov0" title="0">
                handleCustom(c, value)</span>
        case *errs.Validation:<span class="cov0" title="0">
                c.JSON(400, err)</span>
        case validator.ValidationErrors:<span class="cov0" title="0">
                handleValidationError(c, value)</span>
        case error:<span class="cov0" title="0">
                c.JSON(500, gin.H{
                        "error": value.Error(),
                })</span>
        default:<span class="cov0" title="0">
                handleCustom(c, errs.Internal)</span>
        }
}

func handleValidationError(c *gin.Context, validationErrors validator.ValidationErrors) <span class="cov0" title="0">{
        err := errs.NewValidation()

        for _, e := range validationErrors </span><span class="cov0" title="0">{
                err.Add(strings.ToLower(e.Field()), e.Tag())
        }</span>

        <span class="cov0" title="0">c.JSON(400, err)</span>
}

func handleCustom(c *gin.Context, err *errs.Custom) <span class="cov0" title="0">{
        c.JSON(err.Status(), err)
}</span>
</pre>
		
		<pre class="file" id="file24" style="display: none">package server

import (
        "cmp"
        "context"
        "strconv"

        "github.com/gin-gonic/gin"
        "github.com/google/uuid"
        "github.com/nmarsollier/resourcesgo/internal/tools/logx"
)

const ginLogFieldsKey = "ginlogfields"

func GinLoggerMiddleware() gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                fields := logx.NewFields().
                        Add(logx.CONTROLLER, "Rest").
                        Add(logx.HTTP_METHOD, c.Request.Method).
                        Add(logx.HTTP_PATH, c.Request.URL.Path).
                        Add(logx.CORRELATION_ID, getCorrelationId(c))

                c.Set(ginLogFieldsKey, fields)

                c.Next()

                if c.Request.Method != "OPTIONS" </span><span class="cov0" title="0">{
                        fields.Add(logx.HTTP_STATUS, strconv.Itoa(c.Writer.Status()))
                        logx.Info(GinLogCtx(c), "Completed")
                }</span>
        }
}

func GinLogCtx(c *gin.Context) context.Context <span class="cov0" title="0">{
        value := c.MustGet(ginLogFieldsKey).(logx.Fields)
        return logx.CtxWithFields(c, value)
}</span>

func getCorrelationId(c *gin.Context) string <span class="cov0" title="0">{
        return cmp.Or(c.GetHeader(logx.CORRELATION_ID), uuid.New().String())
}</span>
</pre>
		
		<pre class="file" id="file25" style="display: none">package env

import (
        "cmp"
        "os"

        "github.com/nmarsollier/resourcesgo/internal/tools/strs"
)

// Configuration properties
type Configuration struct {
        ServerName  string `json:"serverName"`
        Port        int    `json:"port"`
        GqlPort     int    `json:"gqlPort"`
        PostgresURL string `json:"postgresUrl"`
}

var config *Configuration

// Get returns the singleton instance of the Configuration.
// If the Configuration is not already loaded, it loads the configuration
// by calling the load function and stores it in the config variable.
var Get = func() *Configuration <span class="cov8" title="1">{
        if config == nil </span><span class="cov8" title="1">{
                config = load()
        }</span>

        <span class="cov8" title="1">return config</span>
}

func load() *Configuration <span class="cov8" title="1">{
        return &amp;Configuration{
                ServerName:  cmp.Or(os.Getenv("SERVER_NAME"), "resourcesgo"),
                Port:        cmp.Or(strs.AtoiZero(os.Getenv("PORT")), 3000),
                GqlPort:     cmp.Or(strs.AtoiZero(os.Getenv("GQL_PORT")), 4000),
                PostgresURL: cmp.Or(os.Getenv("POSTGRES_URL"), "postgres://postgres@localhost:5432/postgres"),
        }
}</span>
</pre>
		
		<pre class="file" id="file26" style="display: none">package errs

import (
        "github.com/nmarsollier/resourcesgo/internal/tools/strs"
)

// Custom represents a custom error with an HTTP status code and a message.
// The status field holds the HTTP status code, and the Message field holds
// the error message to be returned in JSON format.
type Custom struct {
        status  int
        Message string `json:"error"`
}

func NewCustom(status int, message string) *Custom <span class="cov8" title="1">{
        return &amp;Custom{
                status:  status,
                Message: message,
        }
}</span>

func (e *Custom) Error() string <span class="cov8" title="1">{
        return strs.ToJson(e.Message)
}</span>

func (e *Custom) Status() int <span class="cov8" title="1">{
        return e.status
}</span>
</pre>
		
		<pre class="file" id="file27" style="display: none">package errs

import "github.com/nmarsollier/resourcesgo/internal/tools/strs"

// Validation represents a collection of validation error messages.
// It contains a slice of Field structs, each representing a specific validation error message.
type Validation struct {
        Messages []Field `json:"messages"`
}

type Field struct {
        Path    string `json:"path"`
        Message string `json:"message"`
}

func NewValidationField(field string, err string) *Validation <span class="cov8" title="1">{
        return &amp;Validation{
                Messages: []Field{
                        {
                                Path:    field,
                                Message: err,
                        },
                },
        }
}</span>

func NewValidation() *Validation <span class="cov8" title="1">{
        return &amp;Validation{
                Messages: []Field{},
        }
}</span>

func (e *Validation) Error() string <span class="cov8" title="1">{
        return strs.ToJson(e)
}</span>

func (e *Validation) Add(path string, message string) *Validation <span class="cov8" title="1">{
        err := Field{
                Path:    path,
                Message: message,
        }
        e.Messages = append(e.Messages, err)
        return e
}</span>

func (e *Validation) Size() int <span class="cov8" title="1">{
        return len(e.Messages)
}</span>
</pre>
		
		<pre class="file" id="file28" style="display: none">package logx

import "context"

type contextKey string

const fieldsKey = contextKey("fields")

// CtxWithFields returns a new context with the provided fields added to it.
// If the context already contains fields, it returns the original context.
//
// Parameters:
//
//        ctx - The original context.
//        fields - The fields to add to the context.
//
// Returns:
//
//        A new context with the fields added, or the original context if it already contains fields.
func CtxWithFields(ctx context.Context, fields Fields) context.Context <span class="cov8" title="1">{
        _, ok := ctx.Value(fieldsKey).(Fields)
        if ok </span><span class="cov8" title="1">{
                return ctx
        }</span>

        <span class="cov8" title="1">return context.WithValue(ctx, fieldsKey, fields)</span>
}

// CtxFields retrieves the Fields from the given context.
// If the context does not contain any Fields, it returns a new Fields instance.
//
// Parameters:
//
//        ctx - the context from which to retrieve the Fields
//
// Returns:
//
//        Fields - the Fields retrieved from the context, or a new Fields instance if none are found
func CtxFields(ctx context.Context) Fields <span class="cov8" title="1">{
        fields, ok := ctx.Value(fieldsKey).(Fields)
        if !ok </span><span class="cov0" title="0">{
                return NewFields()
        }</span>
        <span class="cov8" title="1">return fields</span>
}
</pre>
		
		<pre class="file" id="file29" style="display: none">package logx

import (
        "github.com/google/uuid"
        "github.com/nmarsollier/resourcesgo/internal/tools/env"
)

const CORRELATION_ID = "correlation_id"
const CONTROLLER = "controller"
const RABBIT_ACTION = "rabbit_action"
const HTTP_METHOD = "http_method"
const HTTP_PATH = "http_path"
const HTTP_STATUS = "http_status"
const SERVER = "server"
const THREAD = "thread"

type Fields map[string]string

// NewFields creates a new Fields map with initial server and thread information.
func NewFields() Fields <span class="cov8" title="1">{
        return make(Fields, 4).
                Add(SERVER, env.Get().ServerName).
                Add(THREAD, uuid.New().String())
}</span>

// Add inserts a key-value pair into the Fields map and returns the updated Fields.
//
// Parameters:
//   - key: The key to be added to the Fields map.
//   - value: The value associated with the key.
//
// Returns:
//   - Fields: The pointer to work as a builder.
func (f Fields) Add(key string, value string) Fields <span class="cov8" title="1">{
        f[key] = value
        return f
}</span>
</pre>
		
		<pre class="file" id="file30" style="display: none">package logx

import (
        "context"
        "fmt"
        "log"
        "os"
)

// Logger factory
var newLogger = func() *log.Logger <span class="cov8" title="1">{
        return log.New(os.Stdout, "", log.Ldate|log.Ltime|log.Lshortfile)
}</span>

func ErrorStr(ctx context.Context, err string) <span class="cov8" title="1">{
        logWithFields("ERROR", ctx, err)
}</span>

func Error(ctx context.Context, err error) <span class="cov8" title="1">{
        logWithFields("ERROR", ctx, err.Error())
}</span>

func Info(ctx context.Context, msg string) <span class="cov8" title="1">{
        logWithFields("INFO", ctx, msg)
}</span>

func Warn(ctx context.Context, msg string) <span class="cov8" title="1">{
        logWithFields("WARN", ctx, msg)
}</span>

func logWithFields(level string, ctx context.Context, msg string) <span class="cov8" title="1">{
        logger := newLogger()
        data := ""
        for k, v := range CtxFields(ctx) </span><span class="cov8" title="1">{
                data += fmt.Sprintf("%s=%v;", k, v)
        }</span>
        <span class="cov8" title="1">logger.Println(level, data, msg)</span>
}
</pre>
		
		<pre class="file" id="file31" style="display: none">package strs

import "encoding/json"

// ToJson converts a given object to its JSON string representation.
// Note: This function ignores any errors that occur during the marshaling process.
func ToJson(obj interface{}) string <span class="cov8" title="1">{
        jsonData, _ := json.Marshal(obj)
        return string(jsonData)
}</span>
</pre>
		
		<pre class="file" id="file32" style="display: none">package strs

import "strconv"

// AtoiZero converts a string to an integer. If the conversion fails, it returns 0.
// It uses strconv.Atoi for the conversion.
//
// Parameters:
//
//        s - the string to be converted to an integer
//
// Returns:
//
//        int - the converted integer, or 0 if the conversion fails
func AtoiZero(s string) int <span class="cov8" title="1">{
        i, err := strconv.Atoi(s)
        if err != nil </span><span class="cov8" title="1">{
                return 0
        }</span>
        <span class="cov8" title="1">return i</span>
}

// AtoiDefault converts a string to an integer. If the conversion fails, it returns the provided default value.
// Parameters:
//   - s: The string to be converted to an integer.
//   - def: The default integer value to return if the conversion fails.
//
// Returns:
//   - The integer value of the string if the conversion is successful, otherwise the default value.
func AtoiDefault(s string, def int) int <span class="cov8" title="1">{
        i, err := strconv.Atoi(s)
        if err != nil </span><span class="cov8" title="1">{
                return def
        }</span>
        <span class="cov8" title="1">return i</span>
}
</pre>
		
		<pre class="file" id="file33" style="display: none">package main

import (
        "github.com/nmarsollier/resourcesgo/internal/graph"
        routes "github.com/nmarsollier/resourcesgo/internal/rest"
)

func main() <span class="cov0" title="0">{
        go graph.Start()
        routes.Start()
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
